
<!DOCTYPE html><html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 6.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>tensorflowè‡ªå®šä¹‰ç½‘ç»œæ¨¡å‹ - Caiusçš„æ—¥å¸¸åšå®¢</title>

  
    <meta name="description" content="SlimTF-Slim æ¨¡å—æ˜¯ TensorFlow ä¸­æœ€å¥½ç”¨çš„ API ä¹‹ä¸€ã€‚å°¤å…¶æ˜¯é‡Œé¢å¼•å…¥çš„ arg_scopeã€model_variablesã€repeatã€stackã€‚TF-Slim æ˜¯ TensorFlow ä¸­ä¸€ä¸ªç”¨æ¥æ„å»ºã€è®­ç»ƒã€è¯„ä¼°å¤æ‚æ¨¡å‹çš„è½»é‡åŒ–åº“ã€‚TF-Slim æ¨¡å—å¯ä»¥å’Œ TensorFlow ä¸­å…¶å®ƒAPIæ··åˆä½¿ç”¨ã€‚ Slimæ¨¡å—çš„å¯¼å…¥1    |  import tensorf">
<meta property="og:type" content="article">
<meta property="og:title" content="tensorflowè‡ªå®šä¹‰ç½‘ç»œæ¨¡å‹">
<meta property="og:url" content="https://caiusy.github.io/2019/10/17/tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/">
<meta property="og:site_name" content="Caiusçš„æ—¥å¸¸åšå®¢">
<meta property="og:description" content="SlimTF-Slim æ¨¡å—æ˜¯ TensorFlow ä¸­æœ€å¥½ç”¨çš„ API ä¹‹ä¸€ã€‚å°¤å…¶æ˜¯é‡Œé¢å¼•å…¥çš„ arg_scopeã€model_variablesã€repeatã€stackã€‚TF-Slim æ˜¯ TensorFlow ä¸­ä¸€ä¸ªç”¨æ¥æ„å»ºã€è®­ç»ƒã€è¯„ä¼°å¤æ‚æ¨¡å‹çš„è½»é‡åŒ–åº“ã€‚TF-Slim æ¨¡å—å¯ä»¥å’Œ TensorFlow ä¸­å…¶å®ƒAPIæ··åˆä½¿ç”¨ã€‚ Slimæ¨¡å—çš„å¯¼å…¥1    |  import tensorf">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://caiusy.github.io/images/avatar.jpg">
<meta property="article:published_time" content="2019-10-16T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-20T07:14:34.035Z">
<meta property="article:author" content="Caius Lu">
<meta property="article:tag" content="TensorFlow">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://caiusy.github.io/images/avatar.jpg">
  
  
  
  <meta name="keywords" content="TensorFlow">

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Caius Lu","sameAs":[],"image":"https://caiusy.github.io/images/avatar.jpg"},"dateCreated":"2019-10-17T00:00:00+08:00","dateModified":"2026-02-20T15:14:34+08:00","datePublished":"2019-10-17T00:00:00+08:00","description":"","headline":"tensorflowè‡ªå®šä¹‰ç½‘ç»œæ¨¡å‹","mainEntityOfPage":{"@type":"WebPage","@id":"https://caiusy.github.io/2019/10/17/tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/"},"publisher":{"@type":"Organization","name":"Caius Lu","sameAs":[],"image":"https://caiusy.github.io/images/avatar.jpg","logo":{"@type":"ImageObject","url":"https://caiusy.github.io/images/avatar.jpg"}},"url":"https://caiusy.github.io/2019/10/17/tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/","keywords":"TensorFlow","image":[]}</script>
  <link rel="stylesheet" href="/css/custom.css"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>

<div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/images/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main">Caiusçš„æ—¥å¸¸åšå®¢</div><div class="sub normal cap">è®¡ç®—æœºè§†è§‰</div><div class="sub hover cap" style="opacity:0"> å¤§æ¨¡å‹åˆå­¦è€…</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"><a class="nav-item active" title="åšå®¢" href="/" style="color:#6366F1"><img src="https://api.iconify.design/solar:documents-bold-duotone.svg?color=%236366F1"/></a><a class="nav-item" title="å½’æ¡£" href="/archives/" style="color:#10B981"><img src="https://api.iconify.design/solar:archive-bold-duotone.svg?color=%2310B981"/></a><a class="nav-item" title="åˆ†ç±»" href="/categories/" style="color:#F59E0B"><img src="https://api.iconify.design/solar:folder-with-files-bold-duotone.svg?color=%23F59E0B"/></a><a class="nav-item" title="æ ‡ç­¾" href="/tags/" style="color:#EC4899"><img src="https://api.iconify.design/solar:tag-bold-duotone.svg?color=%23EC4899"/></a></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="Search"></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div>



<widget class="widget-wrapper slide-up recent post-list"><div class="widget-header dis-select"><span class="name">Recent Update</span></div><div class="widget-body fs14"><a class="item title" href="/2026/02/23/graph-theory-and-search/"><span class="title">å›¾è®ºä¸æœç´¢ï¼šä»é›¶åˆ°ç²¾é€šçš„è´¹æ›¼å¼å®Œå…¨æŒ‡å—</span></a><a class="item title" href="/2026/02/22/linkedlist-pointer-complete-guide/"><span class="title">é“¾è¡¨ä¸æŒ‡é’ˆå®Œå…¨å›¾è§£ï¼šä»å†…å­˜æœ¬è´¨åˆ° LeetCode å®æˆ˜</span></a><a class="item title" href="/2026/02/20/20250220-dynamic-programming-complete-guide/"><span class="title">åŠ¨æ€è§„åˆ’å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š</span></a><a class="item title" href="/2019/08/28/20190828-shutil%E6%A8%A1%E5%9D%97/"><span class="title">shutilæ¨¡å—</span></a><a class="item title" href="/2019/09/06/20190906-%E5%8F%98%E6%80%81%E8%B7%B3%E5%8F%B0%E9%98%B6/"><span class="title">å˜æ€è·³å°é˜¶</span></a><a class="item title" href="/2019/10/13/20191013-park%E5%81%9C%E8%BD%A6%E5%9C%BA%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"><span class="title">parkåœè½¦åœºé¡¹ç›®å®æˆ˜</span></a><a class="item title" href="/2026/02/03/bert-comprehensive-guide/"><span class="title">BERT å®Œæ•´è§£æï¼šä»è®ºæ–‡åˆ° KV Cache</span></a><a class="item title" href="/2019/08/28/20190828-opencv%E6%A8%A1%E5%9D%97/"><span class="title">opencvæ¨¡å—</span></a><a class="item title" href="/2019/09/02/20190902-%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/"><span class="title">ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—</span></a><a class="item title" href="/2019/09/12/20190912-%E5%8F%8D%E8%BD%AC%E9%93%BE%E8%A1%A8/"><span class="title">åè½¬é“¾è¡¨</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/caiusy" target="_blank" rel="external nofollow noopener noreferrer"><img src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/08a41b181ce68.svg"/></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner slide-up top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a></div>
<div class="flex-row" id="post-meta"><span class="text created">Posted on: <time datetime="2019-10-16T16:00:00.000Z">2019-10-17</time></span><span class="sep updated"></span><span class="text updated">Updated on: <time datetime="2026-02-20T07:14:34.035Z">2026-02-20</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>tensorflowè‡ªå®šä¹‰ç½‘ç»œæ¨¡å‹</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content slide-up"><h2 id="Slim"><a href="#Slim" class="headerlink" title="Slim"></a>Slim</h2><p>TF-Slim æ¨¡å—æ˜¯ TensorFlow ä¸­æœ€å¥½ç”¨çš„ API ä¹‹ä¸€ã€‚å°¤å…¶æ˜¯é‡Œé¢å¼•å…¥çš„ arg_scopeã€model_variablesã€repeatã€stackã€‚<br>TF-Slim æ˜¯ TensorFlow ä¸­ä¸€ä¸ªç”¨æ¥æ„å»ºã€è®­ç»ƒã€è¯„ä¼°å¤æ‚æ¨¡å‹çš„è½»é‡åŒ–åº“ã€‚TF-Slim æ¨¡å—å¯ä»¥å’Œ TensorFlow ä¸­å…¶å®ƒAPIæ··åˆä½¿ç”¨ã€‚</p>
<h3 id="Slimæ¨¡å—çš„å¯¼å…¥"><a href="#Slimæ¨¡å—çš„å¯¼å…¥" class="headerlink" title="Slimæ¨¡å—çš„å¯¼å…¥"></a>Slimæ¨¡å—çš„å¯¼å…¥</h3><pre><code>1  
</code></pre>
<p>| </p>
<pre><code>import tensorflow.contrib.slim as slim  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="Slim-æ„å»ºæ¨¡å‹"><a href="#Slim-æ„å»ºæ¨¡å‹" class="headerlink" title="Slim æ„å»ºæ¨¡å‹"></a>Slim æ„å»ºæ¨¡å‹</h3><p>å¯ä»¥ç”¨ slimã€variablesã€layers å’Œ scopes æ¥ååˆ†ç®€æ´åœ°å®šä¹‰æ¨¡å‹ã€‚ä¸‹é¢å¯¹å„ä¸ªéƒ¨åˆ†è¿›è¡Œäº†è¯¦ç»†æè¿°ï¼š</p>
<h4 id="Slimå˜é‡ï¼ˆVariablesï¼‰"><a href="#Slimå˜é‡ï¼ˆVariablesï¼‰" class="headerlink" title="Slimå˜é‡ï¼ˆVariablesï¼‰"></a>Slimå˜é‡ï¼ˆVariablesï¼‰</h4><pre><code>1  
2  
3  
4  
5  
6  
</code></pre>
<p>| </p>
<pre><code>weights = slim.variable('weights',  
                        shape=[10, 10, 3 , 3],  
                        initializer=tf.truncated_normal_initializer(stddev=0.1),  
                        regularizer=slim.l2_regularizer(0.05),  
                        device='/CPU:0')  
~  
  
</code></pre>
<p>â€”|â€”  </p>
<h4 id="Slim-å±‚ï¼ˆLayersï¼‰"><a href="#Slim-å±‚ï¼ˆLayersï¼‰" class="headerlink" title="Slim å±‚ï¼ˆLayersï¼‰"></a>Slim å±‚ï¼ˆLayersï¼‰</h4><p>ä½¿ç”¨åŸºç¡€ï¼ˆplainï¼‰çš„ TensorFlow ä»£ç ï¼š  </p>
<pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
</code></pre>
<p>| </p>
<pre><code>input = ...  
with tf.name_scope('conv1_1') as scope:  
  kernel = tf.Variable(tf.truncated_normal([3, 3, 64, 128], dtype=tf.float32,  
                                           stddev=1e-1), name='weights')  
  conv = tf.nn.conv2d(input, kernel, [1, 1, 1, 1], padding='SAME')  
  biases = tf.Variable(tf.constant(0.0, shape=[128], dtype=tf.float32),  
                       trainable=True, name='biases')  
  bias = tf.nn.bias_add(conv, biases)  
  conv1 = tf.nn.relu(bias, name=scope)  
  
</code></pre>
<p>â€”|â€”  </p>
<p>ä¸ºäº†é¿å…ä»£ç çš„é‡å¤ã€‚Slim æä¾›äº†å¾ˆå¤šæ–¹ä¾¿çš„ç¥ç»ç½‘ç»œ layers çš„é«˜å±‚ opã€‚ä¾‹å¦‚ï¼šä¸ä¸Šé¢çš„ä»£ç å¯¹åº”çš„ Slim ç‰ˆçš„ä»£ç ï¼š  </p>
<pre><code>1  
2  
</code></pre>
<p>| </p>
<pre><code>input = ...  
net = slim.conv2d(input, 128, [3, 3], scope='conv1_1')  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="slim-arg-scopeï¼ˆï¼‰-å‡½æ•°çš„ä½¿ç”¨"><a href="#slim-arg-scopeï¼ˆï¼‰-å‡½æ•°çš„ä½¿ç”¨" class="headerlink" title="slim.arg_scopeï¼ˆï¼‰ å‡½æ•°çš„ä½¿ç”¨"></a>slim.arg_scopeï¼ˆï¼‰ å‡½æ•°çš„ä½¿ç”¨</h3><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ç»™list_opsä¸­çš„å†…å®¹è®¾ç½®é»˜è®¤å€¼ã€‚ä½†æ˜¯æ¯ä¸ªlist_opsä¸­çš„æ¯ä¸ªæˆå‘˜éœ€è¦ç”¨@add_arg_scopeä¿®é¥°æ‰è¡Œã€‚æ‰€ä»¥ä½¿ç”¨slim.arg_scopeï¼ˆï¼‰æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li><p>ä½¿ç”¨@slim.add_arg_scopeä¿®é¥°ç›®æ ‡å‡½æ•°</p>
</li>
<li><p>ç”¨ slim.arg_scopeï¼ˆï¼‰ä¸ºç›®æ ‡å‡½æ•°è®¾ç½®é»˜è®¤å‚æ•°.<br>ä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼›é¦–å…ˆç”¨@slim.add_arg_scopeä¿®é¥°ç›®æ ‡å‡½æ•°fun1ï¼ˆï¼‰ï¼Œç„¶ååˆ©ç”¨slim.arg_scopeï¼ˆï¼‰ä¸ºå®ƒè®¾ç½®é»˜è®¤å‚æ•°ã€‚</p>
<pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10
</code></pre>
</li>
</ul>
<p>| </p>
<pre><code>    import tensorflow as tf  
    slim =tf.contrib.slim  
       
    @slim.add_arg_scope  
    def fun1(a=0,b=0):  
        return (a+b)  
       
    with slim.arg_scope([fun1],a=10):  
        x=fun1(b=30)  
        print(x)  
      
</code></pre>
<p>â€”|â€”  </p>
<p>è¿è¡Œç»“æœ:40<br>å‚è€ƒé“¾æ¥ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013921430/article/details/80915696">https://blog.csdn.net/u013921430/article/details/80915696</a></p>
<h3 id="å…¶ä»–ç”¨æ³•è§å‚è€ƒé“¾æ¥"><a href="#å…¶ä»–ç”¨æ³•è§å‚è€ƒé“¾æ¥" class="headerlink" title="å…¶ä»–ç”¨æ³•è§å‚è€ƒé“¾æ¥"></a>å…¶ä»–ç”¨æ³•è§å‚è€ƒé“¾æ¥</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wanttifa/article/details/90208398">https://blog.csdn.net/wanttifa/article/details/90208398</a></p>
<h2 id="æŸ¥çœ‹ckptä¸­å˜é‡çš„å‡ ç§æ–¹æ³•"><a href="#æŸ¥çœ‹ckptä¸­å˜é‡çš„å‡ ç§æ–¹æ³•" class="headerlink" title="æŸ¥çœ‹ckptä¸­å˜é‡çš„å‡ ç§æ–¹æ³•"></a>æŸ¥çœ‹ckptä¸­å˜é‡çš„å‡ ç§æ–¹æ³•</h2><p>æŸ¥çœ‹ckptä¸­å˜é‡çš„æ–¹æ³•æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>åœ¨æœ‰modelçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨tf.train.Saverè¿›è¡Œrestore</li>
<li>ä½¿ç”¨tf.train.NewCheckpointReaderç›´æ¥è¯»å–ckptæ–‡ä»¶ï¼Œè¿™ç§æ–¹æ³•ä¸éœ€è¦modelã€‚</li>
<li>ä½¿ç”¨toolsé‡Œçš„freeze_graphæ¥è¯»å–ckpt<br>Tips:</li>
<li>å¦‚æœæ¨¡å‹ä¿å­˜ä¸º.ckptçš„æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨è¯¥æ–‡ä»¶å°±å¯ä»¥æŸ¥çœ‹.ckptæ–‡ä»¶é‡Œçš„å˜é‡ã€‚ckptè·¯å¾„ä¸º model.ckpt</li>
<li>å¦‚æœæ¨¡å‹ä¿å­˜ä¸º.ckpt-xxx-data (å›¾ç»“æ„)ã€.ckpt-xxx.index (å‚æ•°å)ã€.ckpt-xxx-meta (å‚æ•°å€¼)æ–‡ä»¶ï¼Œåˆ™éœ€è¦åŒæ—¶æ‹¥æœ‰è¿™ä¸‰ä¸ªæ–‡ä»¶æ‰è¡Œã€‚å¹¶ä¸”ckptçš„è·¯å¾„ä¸º model.ckpt-xxx</li>
</ul>
<h3 id="1-åŸºäºmodelæ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡"><a href="#1-åŸºäºmodelæ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡" class="headerlink" title="1.åŸºäºmodelæ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡"></a>1.åŸºäºmodelæ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡</h3><p>1.é¦–å…ˆå»ºç«‹èµ·model<br>2.ä»ckptä¸­æ¢å¤å˜é‡</p>
<pre><code>    1  
    2  
    3  
    4  
    5  
    6  
    7  
    8  
    9  
    10  
    
</code></pre>
<p>| </p>
<pre><code>    with tf.Graph().as_default() as g:   
      #å»ºç«‹model  
      images, labels = cifar10.inputs(eval_data=eval_data)   
      logits = cifar10.inference(images)   
      top_k_op = tf.nn.in_top_k(logits, labels, 1)   
      #ä»ckptä¸­æ¢å¤å˜é‡  
      sess = tf.Session()  
      saver = tf.train.Saver() #saver = tf.train.Saver(...variables...) # æ¢å¤éƒ¨åˆ†å˜é‡æ—¶ï¼Œåªéœ€è¦åœ¨Saveré‡ŒæŒ‡å®šè¦æ¢å¤çš„å˜é‡  
      save_path = 'ckptçš„è·¯å¾„'  
      saver.restore(sess, save_path) # ä»ckptä¸­æ¢å¤å˜é‡  
      
</code></pre>
<p>â€”|â€”  </p>
<p>æ³¨æ„ï¼šåŸºäºmodelæ¥è¯»å–ckptä¸­å˜é‡æ—¶ï¼Œmodelå’Œckptå¿…é¡»åŒ¹é…ã€‚</p>
<h3 id="2-ä½¿ç”¨tf-train-NewCheckpointReaderç›´æ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡ï¼Œä½¿ç”¨tools-inspect-checkpointé‡Œçš„print-tensors-in-checkpoint-fileå‡½æ•°æ‰“å°ckpté‡Œçš„ä¸œè¥¿"><a href="#2-ä½¿ç”¨tf-train-NewCheckpointReaderç›´æ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡ï¼Œä½¿ç”¨tools-inspect-checkpointé‡Œçš„print-tensors-in-checkpoint-fileå‡½æ•°æ‰“å°ckpté‡Œçš„ä¸œè¥¿" class="headerlink" title="2.ä½¿ç”¨tf.train.NewCheckpointReaderç›´æ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡ï¼Œä½¿ç”¨tools.inspect_checkpointé‡Œçš„print_tensors_in_checkpoint_fileå‡½æ•°æ‰“å°ckpté‡Œçš„ä¸œè¥¿"></a>2.ä½¿ç”¨tf.train.NewCheckpointReaderç›´æ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡ï¼Œä½¿ç”¨tools.inspect_checkpointé‡Œçš„print_tensors_in_checkpoint_fileå‡½æ•°æ‰“å°ckpté‡Œçš„ä¸œè¥¿</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
</code></pre>
<p>| </p>
<pre><code>#ä½¿ç”¨NewCheckpointReaderæ¥è¯»å–ckpté‡Œçš„å˜é‡  
from tensorflow.python import pywrap_tensorflow  
checkpoint_path = os.path.join(model_dir, "model.ckpt")  
reader = pywrap_tensorflow.NewCheckpointReader(checkpoint_path) #tf.train.NewCheckpointReader  
var_to_shape_map = reader.get_variable_to_shape_map()  
for key in var_to_shape_map:  
  print("tensor_name: ", key)  
  #print(reader.get_tensor(key))  
#ä½¿ç”¨print_tensors_in_checkpoint_fileæ‰“å°ckpté‡Œçš„å†…å®¹  
from tensorflow.python.tools.inspect_checkpoint import print_tensors_in_checkpoint_file  
  
print_tensors_in_checkpoint_file(file_name, #ckptæ–‡ä»¶åå­—  
                 tensor_name, # å¦‚æœä¸ºNone,åˆ™é»˜è®¤ä¸ºckpté‡Œçš„æ‰€æœ‰å˜é‡  
                 all_tensors, # bool æ˜¯å¦æ‰“å°æ‰€æœ‰çš„tensorï¼Œè¿™é‡Œæ‰“å°å‡ºçš„æ˜¯tensorçš„å€¼ï¼Œä¸€èˆ¬ä¸æ¨èè¿™é‡Œè®¾ç½®ä¸ºFalse  
                 all_tensor_names) # bool æ˜¯å¦æ‰“å°æ‰€æœ‰çš„tensorçš„name  
#ä¸Šé¢çš„æ‰“å°ckptçš„å†…éƒ¨ä½¿ç”¨çš„æ˜¯pywrap_tensorflow.NewCheckpointReaderæ‰€ä»¥è¦æŒæ¡NewCheckpointReader  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="3-ä½¿ç”¨toolsé‡Œçš„freeze-graphæ¥è¯»å–ckpt"><a href="#3-ä½¿ç”¨toolsé‡Œçš„freeze-graphæ¥è¯»å–ckpt" class="headerlink" title="3.ä½¿ç”¨toolsé‡Œçš„freeze_graphæ¥è¯»å–ckpt"></a>3.ä½¿ç”¨toolsé‡Œçš„freeze_graphæ¥è¯»å–ckpt</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
</code></pre>
<p>| </p>
<pre><code>from tensorflow.python.tools import freeze_graph  
  
freeze_graph(input_graph, #=some_graph_def.pb  
       input_saver,   
       input_binary,   
       input_checkpoint, #=model.ckpt  
       output_node_names, #=softmax  
       restore_op_name,   
       filename_tensor_name,   
       output_graph, #='./tmp/frozen_graph.pb'  
       clear_devices,   
       initializer_nodes,   
       variable_names_whitelist='',   
       variable_names_blacklist='',   
       input_meta_graph=None,   
       input_saved_model_dir=None,   
       saved_model_tags='serve',   
       checkpoint_version=2)  
#freeze_graph_test.pyè®²è¿°äº†æ€ä¹ˆä½¿ç”¨freeze_grapgã€‚  
  
</code></pre>
<p>â€”|â€”  </p>
<p>å‚è€ƒé“¾æ¥ï¼š<br><a target="_blank" rel="noopener" href="https://www.jb51.net/article/142183.htm">https://www.jb51.net/article/142183.htm</a></p>
<h2 id="control-dependencies"><a href="#control-dependencies" class="headerlink" title="control_dependencies"></a>control_dependencies</h2><p>tf.control_dependencies(control_inputs)<br>Wrapper for Graph.control_dependencies() using the default graph.<br>See Graph.control_dependencies() for more details.<br>æ­¤å‡½æ•°æŒ‡å®šæŸäº›æ“ä½œæ‰§è¡Œçš„ä¾èµ–å…³ç³»<br>è¿”å›ä¸€ä¸ªæ§åˆ¶ä¾èµ–çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œä½¿ç”¨ with å…³é”®å­—å¯ä»¥è®©åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒä¸­çš„æ“ä½œéƒ½åœ¨ control_inputs æ‰§è¡Œ  </p>
<pre><code>1  
2  
3  
</code></pre>
<p>| </p>
<pre><code>1 with tf.control_dependencies([a, b]):  
2     c = ....  
3     d = ...  
  
</code></pre>
<p>â€”|â€”  </p>
<p>åœ¨æ‰§è¡Œå®Œ aï¼Œb æ“ä½œä¹‹åï¼Œæ‰èƒ½æ‰§è¡Œ cï¼Œd æ“ä½œã€‚æ„æ€å°±æ˜¯ cï¼Œd æ“ä½œä¾èµ– aï¼Œb æ“ä½œ  </p>
<pre><code>1  
2  
</code></pre>
<p>| </p>
<pre><code>1 with tf.control_dependencies([train_step, variable_averages_op]):  
2     train_op = tf.no_op(name='train')  
  
</code></pre>
<p>â€”|â€”  </p>
<p>tf.no_op()è¡¨ç¤ºæ‰§è¡Œå®Œ train_step, variable_averages_op æ“ä½œä¹‹åä»€ä¹ˆéƒ½ä¸åš<br>å‚è€ƒé“¾æ¥ï¼š<br><a target="_blank" rel="noopener" href="http://www.tensorfly.cn/tfdoc/api_docs/python/framework.html#Graph.control_dependencies">http://www.tensorfly.cn/tfdoc/api_docs/python/framework.html#Graph.control_dependencies</a></p>
<h2 id="TensorBoard"><a href="#TensorBoard" class="headerlink" title="TensorBoard"></a>TensorBoard</h2><h3 id="åœ¨TensorBoardä¸­å¯è§†åŒ–å›¾å½¢"><a href="#åœ¨TensorBoardä¸­å¯è§†åŒ–å›¾å½¢" class="headerlink" title="åœ¨TensorBoardä¸­å¯è§†åŒ–å›¾å½¢"></a>åœ¨TensorBoardä¸­å¯è§†åŒ–å›¾å½¢</h3><p>æ„å»ºæ‚¨çš„ç½‘ç»œï¼Œåˆ›å»ºä¸€ä¸ªä¼šè¯(session)ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªTensorFlow File Writerå¯¹è±¡<br>File Writerå®šä¹‰å­˜å‚¨TensorBoardæ–‡ä»¶çš„è·¯å¾„ï¼Œä»¥åŠTensorFlow graphå¯¹è±¡sess.graphæ˜¯ç¬¬äºŒä¸ªå‚æ•°ã€‚  </p>
<pre><code>1  
</code></pre>
<p>| </p>
<pre><code>writer = tf.summary.FileWriter(STORE_PATH, sess.graph)  
  
</code></pre>
<p>â€”|â€”  </p>
<p>å½“åˆ›å»ºä¸€ä¸ªTensorFlowç½‘ç»œåï¼Œå®šä¹‰å¹¶è¿è¡ŒFile Writeræ—¶ï¼Œå°±å¯ä»¥å¯åŠ¨TensorBoardæ¥å¯è§†åŒ–å›¾å½¢ã€‚è¦å®šä¹‰File Writerå¹¶å°†å›¾å½¢å‘é€ç»™å®ƒï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:  </p>
<pre><code>1  
2  
3  
</code></pre>
<p>| </p>
<pre><code># start the session  
with tf.Session() as sess:   
writer = tf.summary.FileWriter(STORE_PATH, sess.graph)  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="å¯åŠ¨TensorBoard"><a href="#å¯åŠ¨TensorBoard" class="headerlink" title="å¯åŠ¨TensorBoard"></a>å¯åŠ¨TensorBoard</h3><pre><code>1  
</code></pre>
<p>| </p>
<pre><code>tensorboard --logdir=STORE_PATH  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="åç§°ç©ºé—´ï¼ˆNamespacesï¼‰"><a href="#åç§°ç©ºé—´ï¼ˆNamespacesï¼‰" class="headerlink" title="åç§°ç©ºé—´ï¼ˆNamespacesï¼‰"></a>åç§°ç©ºé—´ï¼ˆNamespacesï¼‰</h3><p>åç§°ç©ºé—´æ˜¯ä¸€ç§ä½œç”¨åŸŸï¼Œå¯ä»¥ç”¨å®ƒæ¥åŒ…å›´å›¾å½¢ç»„ä»¶ï¼Œä»¥ä¾¿å°†å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚é€šè¿‡è¿™æ ·çš„æ“ä½œï¼Œåç§°ç©ºé—´ä¸­çš„ç»†èŠ‚å°†è¢«æŠ˜å æˆTensorBoardè®¡ç®—å›¾å½¢å¯è§†åŒ–ä¸­çš„å•ä¸ªåç§°ç©ºé—´èŠ‚ç‚¹ã€‚è¦åœ¨TensorFlowä¸­åˆ›å»ºåç§°ç©ºé—´ï¼Œå¯ä»¥ä½¿ç”¨Python withåŠŸèƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>
<pre><code>1  
2  
3  
4  
5  
6  
</code></pre>
<p>| </p>
<pre><code>with tf.name_scope("layer_1"):  
# now declare the weights connecting the input to the hidden  layer  
 W1 = tf.Variable(tf.random_normal([784, 300], stddev=0.01), name='W')  
         b1 = tf.Variable(tf.random_normal([300]), name='b')  
         hidden_logits = tf.add(tf.matmul(x_sc, W1), b1)  
         hidden_out = tf.nn.sigmoid(hidden_logits)  
  
</code></pre>
<p>â€”|â€”  </p>
<p>è¿˜å¯ä»¥ä½¿ç”¨tf.variable_scope()ä»£æ›¿tf.name_scope()ã€‚å˜é‡ä½œç”¨åŸŸæ˜¯TensorFlowä¸­çš„get_variable()å˜é‡å…±äº«æœºåˆ¶çš„ä¸€éƒ¨åˆ†ã€‚</p>
<h3 id="æ ‡é‡æ€»ç»“ï¼ˆScalar-summariesï¼‰"><a href="#æ ‡é‡æ€»ç»“ï¼ˆScalar-summariesï¼‰" class="headerlink" title="æ ‡é‡æ€»ç»“ï¼ˆScalar summariesï¼‰"></a>æ ‡é‡æ€»ç»“ï¼ˆScalar summariesï¼‰</h3><p>åœ¨ç½‘ç»œä¸­çš„ä»»ä½•ä½ç½®ï¼Œéƒ½å¯ä»¥è®°å½•æ ‡é‡(å³å•ä¸ªå®å€¼)æ•°é‡ï¼Œä»¥ä¾¿åœ¨TensorBoardä¸­æ˜¾ç¤ºã€‚è¿™å¯¹äºè·Ÿè¸ªè¯¸å¦‚è®­ç»ƒå‡†ç¡®ç‡çš„æé«˜æˆ–æŸå¤±å‡½æ•°çš„å‡å°‘ï¼Œæˆ–ç ”ç©¶åˆ†å¸ƒçš„æ ‡å‡†å·®ç­‰æ–¹é¢éƒ½å¾ˆæœ‰ç”¨ã€‚æ‰§è¡Œèµ·æ¥å¾ˆå®¹æ˜“ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨è¿™ä¸ªå›¾ä¸­è®°å½•accuracyæ ‡é‡:  </p>
<pre><code>1  
2  
</code></pre>
<p>| </p>
<pre><code># add a summary to store the   
accuracytf.summary.scalar('acc_summary', accuracy)  
  
</code></pre>
<p>â€”|â€”  </p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦åœ¨TensorBoardå¯è§†åŒ–ä¸­ç»™å‡ºæ ‡é‡çš„åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦è®°å½•çš„æ“ä½œ(å¿…é¡»è¿”å›ä¸€ä¸ªå®å€¼)ã€‚scalar()è°ƒç”¨çš„è¾“å‡ºæ˜¯ä¸€ä¸ªæ“ä½œã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘æ²¡æœ‰å°†è¿™ä¸ªæ“ä½œåˆ†é…ç»™Pythonä¸­çš„ä»»ä½•å˜é‡ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·æ„¿æ„ï¼Œå¯ä»¥è¿™æ ·åšã€‚ç„¶è€Œï¼Œä¸TensorFlowä¸­çš„å…¶ä»–æ“ä½œä¸€æ ·ï¼Œè¿™äº›æ±‡æ€»æ“ä½œåœ¨è¿è¡Œä¹‹å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚æ ¹æ®å¼€å‘äººå‘˜æƒ³è¦è§‚å¯Ÿçš„å†…å®¹ï¼Œåœ¨ä»»ä½•ç»™å®šçš„å›¾ä¸­é€šå¸¸éƒ½ä¼šè¿è¡Œè®¸å¤šå¯è§†åŒ–å‡½æ•°ï¼Œå› æ­¤æœ‰ä¸€ä¸ªæ–¹ä¾¿çš„åŠ©æ‰‹å‡½æ•°merge_all()ã€‚è¿™å°†æŠŠå›¾ä¸­çš„æ‰€æœ‰å‡½æ•°è°ƒç”¨åˆå¹¶åœ¨ä¸€èµ·ï¼Œè¿™æ ·æ‚¨åªéœ€è°ƒç”¨mergeæ“ä½œï¼Œå®ƒå°†ä¸ºæ‚¨æ”¶é›†æ‰€æœ‰å…¶ä»–å‡½æ•°æ“ä½œå¹¶è®°å½•æ•°æ®ã€‚å®ƒæ˜¯è¿™æ ·çš„:  </p>
<pre><code>1  
</code></pre>
<p>| </p>
<pre><code>merged = tf.summary.merge_all()  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="å›¾åƒå¯è§†åŒ–"><a href="#å›¾åƒå¯è§†åŒ–" class="headerlink" title="å›¾åƒå¯è§†åŒ–"></a>å›¾åƒå¯è§†åŒ–</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
</code></pre>
<p>| </p>
<pre><code># add summary  
if reuse_variables is None:  
    tf.summary.image('input', images)  
    tf.summary.image('score_map', score_maps)  
    tf.summary.image('score_map_pred', f_score * 255)  
    tf.summary.image('geo_map_0', geo_maps[:, :, :, 0:1])  
    tf.summary.image('geo_map_0_pred', f_geometry[:, :, :, 0:1])  
    tf.summary.image('training_masks', training_masks)  
    tf.summary.scalar('model_loss', model_loss)  
    tf.summary.scalar('total_loss', total_loss)  
  
</code></pre>
<p>â€”|â€”  </p>
<h2 id="æ–‡æœ¬æ£€æµ‹æ¨¡å‹EASTçš„æ­å»º"><a href="#æ–‡æœ¬æ£€æµ‹æ¨¡å‹EASTçš„æ­å»º" class="headerlink" title="æ–‡æœ¬æ£€æµ‹æ¨¡å‹EASTçš„æ­å»º"></a>æ–‡æœ¬æ£€æµ‹æ¨¡å‹EASTçš„æ­å»º</h2><h3 id="æ•°æ®åŠ è½½"><a href="#æ•°æ®åŠ è½½" class="headerlink" title="æ•°æ®åŠ è½½"></a>æ•°æ®åŠ è½½</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
23  
24  
25  
26  
27  
28  
29  
30  
31  
32  
33  
34  
35  
36  
37  
38  
39  
40  
41  
42  
43  
44  
45  
46  
47  
48  
49  
50  
51  
52  
53  
54  
55  
56  
57  
58  
59  
60  
61  
62  
63  
64  
65  
66  
67  
68  
69  
70  
71  
72  
73  
74  
75  
76  
77  
78  
79  
80  
81  
82  
83  
84  
85  
86  
87  
88  
89  
90  
91  
92  
93  
94  
95  
96  
97  
98  
99  
100  
101  
102  
103  
104  
105  
106  
107  
108  
109  
110  
111  
112  
113  
114  
115  
116  
117  
118  
119  
120  
121  
122  
123  
124  
125  
126  
127  
128  
129  
130  
131  
132  
133  
134  
135  
136  
137  
138  
139  
140  
141  
142  
143  
144  
145  
146  
147  
148  
149  
150  
151  
152  
153  
154  
155  
156  
157  
158  
159  
160  
161  
162  
</code></pre>
<p>| </p>
<pre><code>def load_annoataion(p):  
    '''  
    load annotation from the text file  
    :param p:  
    :return:  
    '''  
    text_polys = []  
    text_tags = []  
    if not os.path.exists(p):  
        return np.array(text_polys, dtype=np.float32)  
    with open(p, 'r') as f:  
        reader = csv.reader(f)  
        for line in reader:  
            label = line[-1]  
            # strip BOM. \ufeff for python3,  \xef\xbb\bf for python2  
            line = [i.strip('\ufeff').strip('\xef\xbb\xbf') for i in line]  
  
            x1, y1, x2, y2, x3, y3, x4, y4 = list(map(float, line[:8]))  
            text_polys.append([[x1, y1], [x2, y2], [x3, y3], [x4, y4]])  
            if label == '*' or label == '###':  
                text_tags.append(True)  
            else:  
                text_tags.append(False)  
        return np.array(text_polys, dtype=np.float32), np.array(text_tags, dtype=np.bool)  
          
def generator(input_size=512, batch_size=32,  
            background_ratio=3./8,  
            random_scale=np.array([0.5, 1, 2.0, 3.0]),  
            vis=False):  
    image_list = np.array(get_images())  
    print('{} training images in {}'.format(  
        image_list.shape[0], FLAGS.training_data_path))  
    index = np.arange(0, image_list.shape[0])  
    while True:  
        np.random.shuffle(index)  
        images = []  
        image_fns = []  
        score_maps = []  
        geo_maps = []  
        training_masks = []  
        for i in index:  
            try:  
                im_fn = image_list[i]  
                im = cv2.imread(im_fn)  
                # print im_fn  
                h, w, _ = im.shape  
                txt_fn = im_fn.replace(os.path.basename(im_fn).split('.')[1], 'txt')  
                if not os.path.exists(txt_fn):  
                    print('text file {} does not exists'.format(txt_fn))  
                    continue  
  
                text_polys, text_tags = load_annoataion(txt_fn)  
  
                text_polys, text_tags = check_and_validate_polys(text_polys, text_tags, (h, w))  
                # if text_polys.shape[0] == 0:  
                #     continue  
                # random scale this image  
                rd_scale = np.random.choice(random_scale)  
                im = cv2.resize(im, dsize=None, fx=rd_scale, fy=rd_scale)  
                text_polys *= rd_scale  
                # print rd_scale  
                # random crop a area from image  
                if np.random.rand() &lt; background_ratio:  
                    # crop background  
                    im, text_polys, text_tags = crop_area(im, text_polys, text_tags, crop_background=True)  
                    if text_polys.shape[0] &gt; 0:  
                        # cannot find background  
                        continue  
                    # pad and resize image  
                    new_h, new_w, _ = im.shape  
                    max_h_w_i = np.max([new_h, new_w, input_size])  
                    im_padded = np.zeros((max_h_w_i, max_h_w_i, 3), dtype=np.uint8)  
                    im_padded[:new_h, :new_w, :] = im.copy()  
                    im = cv2.resize(im_padded, dsize=(input_size, input_size))  
                    score_map = np.zeros((input_size, input_size), dtype=np.uint8)  
                    geo_map_channels = 5 if FLAGS.geometry == 'RBOX' else 8  
                    geo_map = np.zeros((input_size, input_size, geo_map_channels), dtype=np.float32)  
                    training_mask = np.ones((input_size, input_size), dtype=np.uint8)  
                else:  
                    im, text_polys, text_tags = crop_area(im, text_polys, text_tags, crop_background=False)  
                    if text_polys.shape[0] == 0:  
                        continue  
                    h, w, _ = im.shape  
  
                    # pad the image to the training input size or the longer side of image  
                    new_h, new_w, _ = im.shape  
                    max_h_w_i = np.max([new_h, new_w, input_size])  
                    im_padded = np.zeros((max_h_w_i, max_h_w_i, 3), dtype=np.uint8)  
                    im_padded[:new_h, :new_w, :] = im.copy()  
                    im = im_padded  
                    # resize the image to input size  
                    new_h, new_w, _ = im.shape  
                    resize_h = input_size  
                    resize_w = input_size  
                    im = cv2.resize(im, dsize=(resize_w, resize_h))  
                    resize_ratio_3_x = resize_w/float(new_w)  
                    resize_ratio_3_y = resize_h/float(new_h)  
                    text_polys[:, :, 0] *= resize_ratio_3_x  
                    text_polys[:, :, 1] *= resize_ratio_3_y  
                    new_h, new_w, _ = im.shape  
                    score_map, geo_map, training_mask = generate_rbox((new_h, new_w), text_polys, text_tags)  
  
                if vis:  
                    fig, axs = plt.subplots(3, 2, figsize=(20, 30))  
                    # axs[0].imshow(im[:, :, ::-1])  
                    # axs[0].set_xticks([])  
                    # axs[0].set_yticks([])  
                    # for poly in text_polys:  
                    #     poly_h = min(abs(poly[3, 1] - poly[0, 1]), abs(poly[2, 1] - poly[1, 1]))  
                    #     poly_w = min(abs(poly[1, 0] - poly[0, 0]), abs(poly[2, 0] - poly[3, 0]))  
                    #     axs[0].add_artist(Patches.Polygon(  
                    #         poly * 4, facecolor='none', edgecolor='green', linewidth=2, linestyle='-', fill=True))  
                    #     axs[0].text(poly[0, 0] * 4, poly[0, 1] * 4, '{:.0f}-{:.0f}'.format(poly_h * 4, poly_w * 4),  
                    #                    color='purple')  
                    # axs[1].imshow(score_map)  
                    # axs[1].set_xticks([])  
                    # axs[1].set_yticks([])  
                    axs[0, 0].imshow(im[:, :, ::-1])  
                    axs[0, 0].set_xticks([])  
                    axs[0, 0].set_yticks([])  
                    for poly in text_polys:  
                        poly_h = min(abs(poly[3, 1] - poly[0, 1]), abs(poly[2, 1] - poly[1, 1]))  
                        poly_w = min(abs(poly[1, 0] - poly[0, 0]), abs(poly[2, 0] - poly[3, 0]))  
                        axs[0, 0].add_artist(Patches.Polygon(  
                            poly, facecolor='none', edgecolor='green', linewidth=2, linestyle='-', fill=True))  
                        axs[0, 0].text(poly[0, 0], poly[0, 1], '{:.0f}-{:.0f}'.format(poly_h, poly_w), color='purple')  
                    axs[0, 1].imshow(score_map[::, ::])  
                    axs[0, 1].set_xticks([])  
                    axs[0, 1].set_yticks([])  
                    axs[1, 0].imshow(geo_map[::, ::, 0])  
                    axs[1, 0].set_xticks([])  
                    axs[1, 0].set_yticks([])  
                    axs[1, 1].imshow(geo_map[::, ::, 1])  
                    axs[1, 1].set_xticks([])  
                    axs[1, 1].set_yticks([])  
                    axs[2, 0].imshow(geo_map[::, ::, 2])  
                    axs[2, 0].set_xticks([])  
                    axs[2, 0].set_yticks([])  
                    axs[2, 1].imshow(training_mask[::, ::])  
                    axs[2, 1].set_xticks([])  
                    axs[2, 1].set_yticks([])  
                    plt.tight_layout()  
                    plt.show()  
                    plt.close()  
  
                images.append(im[:, :, ::-1].astype(np.float32))  
                image_fns.append(im_fn)  
                score_maps.append(score_map[::4, ::4, np.newaxis].astype(np.float32))  
                geo_maps.append(geo_map[::4, ::4, :].astype(np.float32))  
                training_masks.append(training_mask[::4, ::4, np.newaxis].astype(np.float32))  
  
                if len(images) == batch_size:  
                    yield images, image_fns, score_maps, geo_maps, training_masks  
                    images = []  
                    image_fns = []  
                    score_maps = []  
                    geo_maps = []  
                    training_masks = []  
            except Exception as e:  
                import traceback  
                traceback.print_exc()  
                continue  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="ç½‘ç»œæ¨¡å‹çš„æ­å»º"><a href="#ç½‘ç»œæ¨¡å‹çš„æ­å»º" class="headerlink" title="ç½‘ç»œæ¨¡å‹çš„æ­å»º"></a>ç½‘ç»œæ¨¡å‹çš„æ­å»º</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
23  
24  
25  
26  
27  
28  
29  
30  
31  
32  
33  
34  
35  
36  
37  
38  
39  
40  
41  
42  
43  
44  
45  
46  
47  
48  
49  
50  
51  
</code></pre>
<p>| </p>
<pre><code>def model(images, weight_decay=1e-5, is_training=True):  
    '''  
    define the model, we use slim's implemention of resnet  
    '''  
    images = mean_image_subtraction(images)  
  
    with slim.arg_scope(resnet_v1.resnet_arg_scope(weight_decay=weight_decay)):  
        logits, end_points = resnet_v1.resnet_v1_50(images, is_training=is_training, scope='resnet_v1_50')  
  
    with tf.variable_scope('feature_fusion', values=[end_points.values]):  
        batch_norm_params = {  
        'decay': 0.997,  
        'epsilon': 1e-5,  
        'scale': True,  
        'is_training': is_training  
        }  
        with slim.arg_scope([slim.conv2d],  
                            activation_fn=tf.nn.relu,  
                            normalizer_fn=slim.batch_norm,  
                            normalizer_params=batch_norm_params,  
                            weights_regularizer=slim.l2_regularizer(weight_decay)):  
            f = [end_points['pool5'], end_points['pool4'],  
                 end_points['pool3'], end_points['pool2']]  
            for i in range(4):  
                print('Shape of f_{} {}'.format(i, f[i].shape))  
            g = [None, None, None, None]  
            h = [None, None, None, None]  
            num_outputs = [None, 128, 64, 32]  
            for i in range(4):  
                if i == 0:  
                    h[i] = f[i]  
                else:  
                    c1_1 = slim.conv2d(tf.concat([g[i-1], f[i]], axis=-1), num_outputs[i], 1)  
                    h[i] = slim.conv2d(c1_1, num_outputs[i], 3)  
                if i &lt;= 2:  
                    g[i] = unpool(h[i])  
                else:  
                    g[i] = slim.conv2d(h[i], num_outputs[i], 3)  
                print('Shape of h_{} {}, g_{} {}'.format(i, h[i].shape, i, g[i].shape))  
  
            # here we use a slightly different way for regression part,  
            # we first use a sigmoid to limit the regression range, and also  
            # this is do with the angle map  
            F_score = slim.conv2d(g[3], 1, 1, activation_fn=tf.nn.sigmoid, normalizer_fn=None)  
            # 4 channel of axis aligned bbox and 1 channel rotation angle  
            geo_map = slim.conv2d(g[3], 4, 1, activation_fn=tf.nn.sigmoid, normalizer_fn=None) * FLAGS.text_scale  
            angle_map = (slim.conv2d(g[3], 1, 1, activation_fn=tf.nn.sigmoid, normalizer_fn=None) - 0.5) * np.pi/2 # angle is between [-45, 45]  
            F_geometry = tf.concat([geo_map, angle_map], axis=-1)  
  
    return F_score, F_geometry  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="losså‡½æ•°çš„è®¾è®¡"><a href="#losså‡½æ•°çš„è®¾è®¡" class="headerlink" title="losså‡½æ•°çš„è®¾è®¡"></a>losså‡½æ•°çš„è®¾è®¡</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
23  
24  
25  
26  
27  
28  
29  
30  
31  
32  
33  
34  
</code></pre>
<p>| </p>
<pre><code>def loss(y_true_cls, y_pred_cls,  
         y_true_geo, y_pred_geo,  
         training_mask):  
    '''  
    define the loss used for training, contraning two part,  
    the first part we use dice loss instead of weighted logloss,  
    the second part is the iou loss defined in the paper  
    :param y_true_cls: ground truth of text  
    :param y_pred_cls: prediction os text  
    :param y_true_geo: ground truth of geometry  
    :param y_pred_geo: prediction of geometry  
    :param training_mask: mask used in training, to ignore some text annotated by ###  
    :return:  
    '''  
    classification_loss = dice_coefficient(y_true_cls, y_pred_cls, training_mask)  
    # scale classification loss to match the iou loss part  
    classification_loss *= 0.01  
  
    # d1 -&gt; top, d2-&gt;right, d3-&gt;bottom, d4-&gt;left  
    d1_gt, d2_gt, d3_gt, d4_gt, theta_gt = tf.split(value=y_true_geo, num_or_size_splits=5, axis=3)  
    d1_pred, d2_pred, d3_pred, d4_pred, theta_pred = tf.split(value=y_pred_geo, num_or_size_splits=5, axis=3)  
    area_gt = (d1_gt + d3_gt) * (d2_gt + d4_gt)  
    area_pred = (d1_pred + d3_pred) * (d2_pred + d4_pred)  
    w_union = tf.minimum(d2_gt, d2_pred) + tf.minimum(d4_gt, d4_pred)  
    h_union = tf.minimum(d1_gt, d1_pred) + tf.minimum(d3_gt, d3_pred)  
    area_intersect = w_union * h_union  
    area_union = area_gt + area_pred - area_intersect  
    L_AABB = -tf.log((area_intersect + 1.0)/(area_union + 1.0))  
    L_theta = 1 - tf.cos(theta_pred - theta_gt)  
    tf.summary.scalar('geometry_AABB', tf.reduce_mean(L_AABB * y_true_cls * training_mask))  
    tf.summary.scalar('geometry_theta', tf.reduce_mean(L_theta * y_true_cls * training_mask))  
    L_g = L_AABB + 20 * L_theta  
  
    return tf.reduce_mean(L_g * y_true_cls * training_mask) + classification_loss  
  
</code></pre>
<p>â€”|â€”  </p>
<h3 id="train"><a href="#train" class="headerlink" title="train"></a>train</h3><pre><code>1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
23  
24  
25  
26  
27  
28  
29  
30  
31  
32  
33  
34  
35  
36  
37  
38  
39  
40  
41  
42  
43  
44  
45  
46  
47  
48  
49  
50  
51  
52  
53  
54  
55  
56  
57  
58  
59  
60  
61  
62  
63  
64  
65  
66  
67  
68  
69  
70  
71  
72  
73  
74  
75  
76  
77  
78  
79  
80  
81  
82  
83  
84  
85  
86  
87  
88  
89  
90  
91  
92  
93  
94  
95  
96  
97  
98  
99  
100  
101  
102  
103  
104  
105  
106  
107  
108  
109  
110  
111  
112  
</code></pre>
<p>| </p>
<pre><code>def main(argv=None):  
    import os  
    os.environ['CUDA_VISIBLE_DEVICES'] = FLAGS.gpu_list  
    config = None  
    config.batch_size = FLAGS.batch_size_per_gpu * FLAGS.num_gpus  
    if not tf.gfile.Exists(FLAGS.checkpoint_path):  
        tf.gfile.MkDir(FLAGS.checkpoint_path)  
    else:  
        if not FLAGS.restore:  
            tf.gfile.DeleteRecursively(FLAGS.checkpoint_path)  
            tf.gfile.MkDir(FLAGS.checkpoint_path)  
  
    input_images = tf.placeholder(tf.float32, shape=[None, None, None, 3], name='input_images')  
    input_score_maps = tf.placeholder(tf.float32, shape=[None, None, None, 1], name='input_score_maps')  
    if FLAGS.geometry == 'RBOX':  
        input_geo_maps = tf.placeholder(tf.float32, shape=[None, None, None, 5], name='input_geo_maps')  
    else:  
        input_geo_maps = tf.placeholder(tf.float32, shape=[None, None, None, 8], name='input_geo_maps')  
    input_training_masks = tf.placeholder(tf.float32, shape=[None, None, None, 1], name='input_training_masks')  
  
    global_step = tf.get_variable('global_step', [], initializer=tf.constant_initializer(0), trainable=False)  
    learning_rate = tf.train.exponential_decay(FLAGS.learning_rate, global_step, decay_steps=10000, decay_rate=0.94, staircase=True)  
    # add summary  
    tf.summary.scalar('learning_rate', learning_rate)  
    opt = tf.train.AdamOptimizer(learning_rate)  
    # opt = tf.train.MomentumOptimizer(learning_rate, 0.9)  
  
  
    # split  
    input_images_split = tf.split(input_images, len(gpus))  
    input_score_maps_split = tf.split(input_score_maps, len(gpus))  
    input_geo_maps_split = tf.split(input_geo_maps, len(gpus))  
    input_training_masks_split = tf.split(input_training_masks, len(gpus))  
  
    tower_grads = []  
    reuse_variables = None  
    for i, gpu_id in enumerate(gpus):  
        with tf.device('/gpu:%d' % gpu_id):  
            with tf.name_scope('model_%d' % gpu_id) as scope:  
                iis = input_images_split[i]  
                isms = input_score_maps_split[i]  
                igms = input_geo_maps_split[i]  
                itms = input_training_masks_split[i]  
                total_loss, model_loss = tower_loss(iis, isms, igms, itms, reuse_variables)  
                batch_norm_updates_op = tf.group(*tf.get_collection(tf.GraphKeys.UPDATE_OPS, scope))  
                reuse_variables = True  
  
                grads = opt.compute_gradients(total_loss)  
                tower_grads.append(grads)  
  
    grads = average_gradients(tower_grads)  
    apply_gradient_op = opt.apply_gradients(grads, global_step=global_step)  
  
    summary_op = tf.summary.merge_all()  
    # save moving average  
    variable_averages = tf.train.ExponentialMovingAverage(  
        FLAGS.moving_average_decay, global_step)  
    variables_averages_op = variable_averages.apply(tf.trainable_variables())  
    # batch norm updates  
    with tf.control_dependencies([variables_averages_op, apply_gradient_op, batch_norm_updates_op]):  
        train_op = tf.no_op(name='train_op')  
  
    saver = tf.train.Saver(tf.global_variables())  
    summary_writer = tf.summary.FileWriter(FLAGS.checkpoint_path, tf.get_default_graph())  
  
    init = tf.global_variables_initializer()  
  
    if FLAGS.pretrained_model_path is not None:  
        variable_restore_op = slim.assign_from_checkpoint_fn(FLAGS.pretrained_model_path, slim.get_trainable_variables(),  
                                                            ignore_missing_vars=True)  
    with tf.Session(config=tf.ConfigProto(allow_soft_placement=True)) as sess:  
        if FLAGS.restore:  
            print('continue training from previous checkpoint')  
            ckpt = tf.train.latest_checkpoint(FLAGS.checkpoint_path)  
            saver.restore(sess, ckpt)  
        else:  
            sess.run(init)  
            if FLAGS.pretrained_model_path is not None:  
                variable_restore_op(sess)  
  
        # data_generator = icdar.get_batch(num_workers=FLAGS.num_readers,  
        #                                 input_size=FLAGS.input_size,  
        #                                 batch_size=FLAGS.batch_size_per_gpu * len(gpus))  
        train_data_generator = icdar_single.get_batch_seq(num_workers=FLAGS.num_readers, config=config, is_training=True)  
  
        start = time.time()  
        for step in range(FLAGS.max_steps):  
            data = next(train_data_generator)  
            ml, tl, _ = sess.run([model_loss, total_loss, train_op], feed_dict={input_images: data[0],  
                                                                                input_score_maps: data[2],  
                                                                                input_geo_maps: data[3],  
                                                                                input_training_masks: data[4]})  
            if np.isnan(tl):  
                print('Loss diverged, stop training')  
                break  
  
            if step % 10 == 0:  
                avg_time_per_step = (time.time() - start)/10  
                avg_examples_per_second = (10 * FLAGS.batch_size_per_gpu * len(gpus))/(time.time() - start)  
                start = time.time()  
                print('Step {:06d}, model loss {:.4f}, total loss {:.4f}, {:.2f} seconds/step, {:.2f} examples/second'.format(  
                    step, ml, tl, avg_time_per_step, avg_examples_per_second))  
  
            if step % FLAGS.save_checkpoint_steps == 0:  
                saver.save(sess, FLAGS.checkpoint_path + 'model.ckpt', global_step=global_step)  
  
            if step % FLAGS.save_summary_steps == 0:  
                _, tl, summary_str = sess.run([train_op, total_loss, summary_op], feed_dict={input_images: data[0],  
                                                                                            input_score_maps: data[2],  
                                                                                            input_geo_maps: data[3],  
                                                                                            input_training_masks: data[4]})  
                summary_writer.add_summary(summary_str, global_step=step)  
  
</code></pre>
<p>â€”|â€”  </p>
<p>å‚è€ƒé“¾æ¥ï¼š<br><a target="_blank" rel="noopener" href="https://github.com/argman/EAST">https://github.com/argman/EAST</a></p>
</article>
<div class="article-footer slide-up">


    <section id="share">
      <div class="header"><span>Share</span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://caiusy.github.io/2019/10/17/tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;Copied!&quot;)"><img  src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://caiusy.github.io/2019/10/17/tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/"/>
        </div>
        
      </div>
    </section>
    </div>

<div class="related-wrap slide-up" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/2019/10/17/20191017-tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/">tensorflowè‡ªå®šä¹‰ç½‘ç»œæ¨¡å‹</a></div><div class="item" id="next"><div class="note">Older</div><a href="/2019/10/14/20191014-%E5%9B%BE%E5%83%8F%E5%A2%9E%E5%BC%BA%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0/">å›¾åƒå¢å¼ºå¸¸ç”¨å‡½æ•°</a></div></section></div>




  <div class="related-wrap md-text slide-up" id="comments">
    <section class='header cmt-title cap theme'>
      <p>ğŸ’¬ æ¬¢è¿ç•™è¨€è®¨è®º</p>

    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" src="https://giscus.app/client.js" data-repo="caiusy/caiusy.github.io" data-repo-id="R_kgDOI0diCA" data-category="Announcements" data-category-id="DIC_kwDOI0diCM4C1G8d" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



<footer class="page-footer slide-up footnote"><hr><div class="sitemap" style="column-count:3;"><div class="sitemap-group"><span class="fs15">åšå®¢</span><a href="/">è¿‘æœŸå‘å¸ƒ</a><a href="/categories/">åˆ†ç±»</a><a href="/tags/">æ ‡ç­¾</a><a href="/archives/">å½’æ¡£</a></div><div class="sitemap-group"><span class="fs15">æŠ€æœ¯é¢†åŸŸ</span><a href="/tags/CV/">è®¡ç®—æœºè§†è§‰</a><a href="/tags/tracking/">ç›®æ ‡è·Ÿè¸ª</a><a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a></div><div class="sitemap-group"><span class="fs15">å…³äº</span><a href="/about/">å…³äºæˆ‘</a><a target="_blank" rel="noopener" href="https://github.com/caiusy">GitHub</a></div></div><div class="text"><p>æœ¬ç«™ç”± <strong>Caius Lu</strong> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> ä¸»é¢˜åˆ›å»º<br>Â© 2023-2026 Â· æ¢ç´¢ AI ä¸è®¡ç®—æœºè§†è§‰çš„æ— é™å¯èƒ½ ğŸš€</p>
<p><span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡</span> | <span id="busuanzi_container_site_uv">è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper slide-up toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">On This Page</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Slim"><span class="toc-text">Slim</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Slim%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AF%BC%E5%85%A5"><span class="toc-text">Slimæ¨¡å—çš„å¯¼å…¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Slim-%E6%9E%84%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="toc-text">Slim æ„å»ºæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Slim%E5%8F%98%E9%87%8F%EF%BC%88Variables%EF%BC%89"><span class="toc-text">Slimå˜é‡ï¼ˆVariablesï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Slim-%E5%B1%82%EF%BC%88Layers%EF%BC%89"><span class="toc-text">Slim å±‚ï¼ˆLayersï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slim-arg-scope%EF%BC%88%EF%BC%89-%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">slim.arg_scopeï¼ˆï¼‰ å‡½æ•°çš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%94%A8%E6%B3%95%E8%A7%81%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">å…¶ä»–ç”¨æ³•è§å‚è€ƒé“¾æ¥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bckpt%E4%B8%AD%E5%8F%98%E9%87%8F%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-text">æŸ¥çœ‹ckptä¸­å˜é‡çš„å‡ ç§æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E4%BA%8Emodel%E6%9D%A5%E8%AF%BB%E5%8F%96ckpt%E6%96%87%E4%BB%B6%E9%87%8C%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">1.åŸºäºmodelæ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8tf-train-NewCheckpointReader%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96ckpt%E6%96%87%E4%BB%B6%E9%87%8C%E7%9A%84%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BD%BF%E7%94%A8tools-inspect-checkpoint%E9%87%8C%E7%9A%84print-tensors-in-checkpoint-file%E5%87%BD%E6%95%B0%E6%89%93%E5%8D%B0ckpt%E9%87%8C%E7%9A%84%E4%B8%9C%E8%A5%BF"><span class="toc-text">2.ä½¿ç”¨tf.train.NewCheckpointReaderç›´æ¥è¯»å–ckptæ–‡ä»¶é‡Œçš„å˜é‡ï¼Œä½¿ç”¨tools.inspect_checkpointé‡Œçš„print_tensors_in_checkpoint_fileå‡½æ•°æ‰“å°ckpté‡Œçš„ä¸œè¥¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8tools%E9%87%8C%E7%9A%84freeze-graph%E6%9D%A5%E8%AF%BB%E5%8F%96ckpt"><span class="toc-text">3.ä½¿ç”¨toolsé‡Œçš„freeze_graphæ¥è¯»å–ckpt</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#control-dependencies"><span class="toc-text">control_dependencies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TensorBoard"><span class="toc-text">TensorBoard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8TensorBoard%E4%B8%AD%E5%8F%AF%E8%A7%86%E5%8C%96%E5%9B%BE%E5%BD%A2"><span class="toc-text">åœ¨TensorBoardä¸­å¯è§†åŒ–å›¾å½¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8TensorBoard"><span class="toc-text">å¯åŠ¨TensorBoard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4%EF%BC%88Namespaces%EF%BC%89"><span class="toc-text">åç§°ç©ºé—´ï¼ˆNamespacesï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E9%87%8F%E6%80%BB%E7%BB%93%EF%BC%88Scalar-summaries%EF%BC%89"><span class="toc-text">æ ‡é‡æ€»ç»“ï¼ˆScalar summariesï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-text">å›¾åƒå¯è§†åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8BEAST%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-text">æ–‡æœ¬æ£€æµ‹æ¨¡å‹EASTçš„æ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="toc-text">æ•°æ®åŠ è½½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-text">ç½‘ç»œæ¨¡å‹çš„æ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loss%E5%87%BD%E6%95%B0%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">losså‡½æ•°çš„è®¾è®¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#train"><span class="toc-text">train</span></a></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>Scroll to Top</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M8 10.5h8M8 14h5.5M17 3.338A9.95 9.95 0 0 0 12 2C6.477 2 2 6.477 2 12c0 1.6.376 3.112 1.043 4.453c.178.356.237.763.134 1.148l-.595 2.226a1.3 1.3 0 0 0 1.591 1.592l2.226-.596a1.63 1.63 0 0 1 1.149.133A9.96 9.96 0 0 0 12 22c5.523 0 10-4.477 10-10c0-1.821-.487-3.53-1.338-5"/></svg><span>Join Discussion</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"closeEnable":true,"closeText":"å…³é—­æç¤º","originalHost":null,"officialHosts":["localhost"],"encoded":""};
  window.canonical["param"] = {"permalink":"https://caiusy.github.io/2019/10/17/tensorflow%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/","checklink":"/js/plugins/video.js"};
  const ctx = {
    date_suffix: {
      just: `Just`,
      min: `minutes ago`,
      hour: `hours ago`,
      day: `days ago`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":null,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        if ($(el).find('.loading-wrap').length == 0){
          $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
        }
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] è¶…æ—¶:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('è¯·æ±‚è¶…æ—¶');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('å“åº”å¤±è´¥');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] é”™è¯¯:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // é€šçŸ¥ LazyLoad æ›´æ–°
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: è¿™ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨ preferred_color_scheme ä»¥å¤–çš„ä¸»é¢˜
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `Switched to Light Mode`,
      dark: `Switched to Dark Mode`,
      auto: `Switched to Auto Mode`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->

  <script type="module">
  const el = document.querySelector('#comments #giscus');
  util.viewportLazyload(el, load_discus, true);

  function load_discus() {
    if (!el) return;
    try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      const script = document.createElement('script');
      script.async = true;
      for (const key of Object.keys(el.attributes)) {
        const attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
  }
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"},"rss":{"js":"/js/services/rss.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.chat-file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.md-text img:not([class]), .md-text .image img, .timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script defer src="https://gcore.jsdelivr.net/npm/scrollreveal@4.0/dist/scrollreveal.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const slideUp = {
      distance: `16px`,
      duration: `600`,
      interval: `100`,
      scale: `1`,
      opacity: 0,
      easing: "ease-out"
    };
    ScrollReveal().reveal('.slide-up', { ...slideUp });
  });
</script>

<script>
  window.MathJax = {
    tex: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"],
      ],
      processEscapes: true,
      skipTags: ["script", "noscript", "style", "textarea", "pre", "code"],
    },
    startup: {
      ready() {
        MathJax.startup.defaultReady();
        MathJax.typesetPromise().then(() => {
          const math = document.querySelectorAll("mjx-container");
          math.forEach((element) => {
            if (element.parentNode) {
              element.parentNode.classList.add("has-jax");
            }
          });
        });
      },
    },
  };
</script>

<script id="MathJax-script" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js" async></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
